# Redis集群之主从、哨兵、分片集群

首先,我们要知道一点,单机版的Redis也支持高并发的读写



## 一、主从集群

相信有一点集群知识的人，一看到主从集群脑海里很快就浮现出了概念图，没错正如你所想的。

![在这里插入图片描述](../../../图片保存\20210426162540291.png)

单机模式下，如果Redis宕机了，那服务就会不可用了。

所以我们需要搭建主从集群,如果主机挂掉,切换从机系统恢复数据依然能正常使用

**具体工作机制为：**

- slave从机启动后，向master主机发送SYNC同步命令，master主机接收到SYNC同步命令后通过bgsave异步保存快照（即RDB持久化）
- master主机将保存的快照文件发送给slave从机，并使用缓冲区记录执行的写命令
- slave从机接收到快照文件后，加载快照文件，载入数据,从机数据恢复
- master主机快照发送完后开始向slave从机发送缓冲区的写命令，slave接收命令并执行，完成复制初始化
- 此后master主机每次执行一个写命令都会同步发送给slave从机，保持master主机与slave从机之间数据的最终一致性(因为是异步同步,所以只能保证最终一致性,而不是一致性)

优点：

- master主机能自动将数据同步到slave从机，做数据备份,主机挂掉,可以手动切换从机为主机
- master主机、slave从机之间的同步是以非阻塞的方式进行的，同步期间，客户端仍然可以提交查询或更新请求

缺点：

- master主机宕机，如果宕机前数据没有同步完，则切换从机后会存在数据不一致的问题
- 难以支持在线扩容，Redis的容量受限于单机配置

注意: Redis主从集群本身是没有读写分离的,但是从机是支持读的,可以自己用程序实现读写分离

官方也不推荐,因为读写分离会出现数据一致性问题,所以主从集群只有主机提供服务,从机默认仅仅做数据备份

## 二、哨兵集群

哨兵模式基于主从复制模式，只是引入了哨兵机制来完善主从复制的缺陷

原因是主从复制机制主节点挂掉不能主从切换的问题

写了一段程序来控制主从切换,这段程序叫哨兵,结合Redis主从复制机制叫做哨兵模式

注意: 哨兵有多个,并且一个哨兵节点也是一台Redis服务器,但不做数据存取

一般的架构是: 1台主机,2台从机,3台哨兵

![img](../../../图片保存\v2-035d143e147fc3477114ee41cc97d759_720w.jpg)

哨兵的作用: 当master主机出现故障时，能主从切换

1 监控: 哨兵会监控所有主从服务器是否正常

2 通知：监控的某个 Redis 挂掉时， 哨兵通知其他哨兵确认节点是否真的挂掉,准备主从切换

3 主从切换: 当哨兵确认主服务器不能正常工作时，哨兵会自动进行故障迁移，主从切换

**具体工作机制为：**

- 每个哨兵它所知的主、从服务器以及其他哨兵发送 PING 命令
- 某个主、从服务器距离最后一次回复 PING 命令的时间超过指定的值， 那么这个服务器会被哨兵标记为主观下线,就是发现节点可能挂掉了
- 一个主服务器被标记为主观下线(可能挂掉了)， 那么所有哨兵都要确认主服务器是否真的挂掉
- 当有足够数量的哨兵(至少要达到配置文件指定的数量)同意这一判断， 大半哨兵都检测为确实挂掉了,主服务器被标记为客观下线,就是确定挂掉了
- 选举的领头哨兵对系统进行故障恢复主从切换,在从数据库中挑选一个来当选新的master

优点：

- 哨兵模式是基于主从模式的，所有主从的优点，哨兵模式都具有
- 主从可以自动切换，系统更健壮，可用性更高(可以看作自动版的主从复制)

缺点:

- 需要另外部署一套哨兵集群，部署麻烦、原理复杂、浪费资源
- 依旧难以扩容,Redis部署好之后,如果内存不够,需要加机器加内存重新部署
- 所有主节点和从节点都包含了 Redis 全量的数据，数据冗余，导致数据存储的数据量有限

注意: Redis哨兵集群本身也是没有读写分离的,哨兵集群也只有主机提供服务,从机默认仅仅做数据备份

# 三、分片集群

Cluster分片集群是为了解决哨兵模式额外部署哨兵节点、内存扩容困难、数据冗余等问题出现的

Cluster分片模式集群节点最小配置6个节点(3主3从，因为需要半数以上)

分片集群的作用

1 去掉额外的哨兵节点,

2 利用hash槽每台节点存储不同的内容,解决数据冗余、提升读写性能、提供在线扩容

**具体工作机制为：**

- 在Redis的每个节点上，都有一个插槽（slot），取值范围为0-16383
- 当我们存取key的时候，Redis会根据CRC16的算法得出一个结果，然后把结果对16384求余数，这样每个key都会对应一个编号在0-16383之间的哈希槽，通过这个值，去找到对应的插槽所对应的节点，然后直接自动跳转到这个对应的节点上进行存取操作
- 为了保证高可用，Cluster模式也引入主从复制模式，一个主节点对应一个或者多个从节点，当主节点宕机的时候，就会启用从节点
- 当其它主节点ping一个主节点A时，如果半数以上的主节点与A通信超时，那么认为主节点A宕机了。

优点: 

- 使用插槽的机制,再次提升了Redis的读写能力,如果出现了单机Redis都不能承受的高并发,那么使用分片集群空可以再次提示Redis的高并发能力
- 提供在线扩容,可以在线增加一台服务器到Redis集群,分担Redis内存上的压力

缺点: 

- 一个分片的主机和从机都宕机,会导致整个集群不可用
- 不支持多数据库空间，单机redis可以支持16个db，集群模式下只能使用一个

注意: Redis分片集群本身也是没有读写分离的,分片集群也只有主机提供服务,从机默认仅仅做数据备份



使用场景:

如果需要使用集群的时候,默认选择Cluster分片集群就可以

Cluster分片集群是Redis官方目前为止最完善的集群方式

在部署方面,主从模式是最简单的部署方式

哨兵和Cluster分片集群相比,Cluster分片会更加方便一些

(当然也有版本的限制,Redis5.0时官方才将Cluster分片部署打包到Redis本地,之前用第三方工具部署会麻烦一些)

所以理论上哨兵模式是被淘汰的

部署上哨兵比主从复制稍复杂,功能上哨兵要弱于Cluster分片

所以要么选择简单的主从复制,要么选择功能完善的Cluster分片集群

在我看来主从模式和哨兵集群这都不能算是真正的集群，只有Redis分片集群模式才是真的集群